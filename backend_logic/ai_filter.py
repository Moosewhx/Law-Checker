import tldextract
import httpx
import urllib3
from openai import OpenAI

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# ğŸ”§ æ”¹è¿›çš„ç³»ç»Ÿæç¤ºè¯ - æ›´ä¿å®ˆã€æ›´å…·ä½“
_SYS = (
    "ã‚ãªãŸã¯å»ºç¯‰åŸºæº–æ³•ã¨éƒ½å¸‚è¨ˆç”»æ³•ã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®URLãŒå»ºç¯‰è¦åˆ¶ã®ã€Œå…·ä½“çš„ãªæ•°å€¤ã€ã‚’å«ã‚€æ–‡æ›¸ã®å¯èƒ½æ€§ã‚’åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚\n\n"
    
    "ã€é‡è¦ã€‘éå¸¸ã«ä¿å®ˆçš„ã«åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚è¿·ã£ãŸå ´åˆã¯ã€ã„ã„ãˆã€ã¨ç­”ãˆã¦ãã ã•ã„ã€‚\n\n"
    
    "ã€ã€ã¯ã„ã€ã¨åˆ¤å®šã™ã¹ãå†…å®¹ã€‘ä»¥ä¸‹ã®å…·ä½“çš„æ•°å€¤è¦åˆ¶ã‚’å«ã‚€å¯èƒ½æ€§ãŒé«˜ã„å ´åˆã®ã¿ï¼š\n"
    "âœ… å»ºè”½ç‡ãƒ»å®¹ç©ç‡ã®å…·ä½“çš„æ•°å€¤ï¼ˆä¾‹ï¼š60%ã€200%ãªã©ï¼‰\n"
    "âœ… é«˜ã•åˆ¶é™ã®å…·ä½“çš„æ•°å€¤ï¼ˆä¾‹ï¼š10mã€15mä»¥ä¸‹ãªã©ï¼‰\n" 
    "âœ… ç”¨é€”åœ°åŸŸå›³ãƒ»éƒ½å¸‚è¨ˆç”»å›³ã®è©³ç´°è³‡æ–™\n"
    "âœ… é–‹ç™ºæŒ‡å°è¦ç¶±ã®å…·ä½“çš„åŸºæº–å€¤\n"
    "âœ… åœ°åŒºè¨ˆç”»ã®è©³ç´°è¦åˆ¶è³‡æ–™\n"
    "âœ… å»ºç¯‰ç¢ºèªç”³è«‹ã®æŠ€è¡“åŸºæº–\n\n"
    
    "ã€ã€ã„ã„ãˆã€ã¨åˆ¤å®šã™ã¹ãå†…å®¹ã€‘ä»¥ä¸‹ã¯å¿…ãšé™¤å¤–ã—ã¦ãã ã•ã„ï¼š\n"
    "âŒ ä¼šè­°å®¤ãƒ»æ–½è¨­äºˆç´„é–¢é€£ï¼ˆreservation, booking, äºˆç´„, è²¸å‡º, åˆ©ç”¨æ¡ˆå†…ï¼‰\n"
    "âŒ ã‚¤ãƒ™ãƒ³ãƒˆãƒ»å‚¬ã—ç‰©ãƒ»ãŠçŸ¥ã‚‰ã›ï¼ˆevent, news, ãŠçŸ¥ã‚‰ã›, å‚¬ã—, è¬›åº§ï¼‰\n"
    "âŒ ä¸€èˆ¬è¡Œæ”¿ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆæˆ¸ç±, ä½æ°‘ç¥¨, ç¨é‡‘, å›½ä¿, ä»‹è­·, ç¦ç¥‰, å­è‚²ã¦ï¼‰\n"
    "âŒ è·å“¡æ¡ç”¨ãƒ»å…¥æœ­æƒ…å ±ï¼ˆæ¡ç”¨, å‹Ÿé›†, å…¥æœ­, å¥‘ç´„, äººäº‹ï¼‰\n"
    "âŒ è¦³å…‰ãƒ»æ–‡åŒ–ãƒ»ã‚¹ãƒãƒ¼ãƒ„ï¼ˆè¦³å…‰, æ–‡åŒ–, ã‚¹ãƒãƒ¼ãƒ„, ãƒ¬ã‚¯ãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰\n"
    "âŒ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ»å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆenquete, form, ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼‰\n"
    "âŒ ã‚µã‚¤ãƒˆãƒãƒªã‚·ãƒ¼ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ï¼ˆpolicy, privacy, åˆ©ç”¨è¦ç´„ï¼‰\n"
    "âŒ æ¦‚è¦ãƒ»ç´¹ä»‹ã®ã¿ã®ãƒšãƒ¼ã‚¸ï¼ˆå…·ä½“çš„æ•°å€¤ãªã—ï¼‰\n"
    "âŒ ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ãƒ»ã‚µã‚¤ãƒˆãƒãƒƒãƒ—ï¼ˆcategory, sitemapï¼‰\n\n"
    
    "ã€åˆ¤å®šä¾‹ã€‘\n"
    "ã€ã¯ã„ã€ã®ä¾‹ï¼š\n"
    "- /toshi/keikaku/youto/kijun.pdf (ç”¨é€”åœ°åŸŸåŸºæº–)\n"
    "- /kenchiku/shido/youkou.html (å»ºç¯‰æŒ‡å°è¦ç¶±)\n"
    "- /kaihatu/kijun/takasa.pdf (é–‹ç™ºåŸºæº–ãƒ»é«˜ã•åˆ¶é™)\n\n"
    
    "ã€ã„ã„ãˆã€ã®ä¾‹ï¼š\n"
    "- /yoyaku/kaigishitsu.html (ä¼šè­°å®¤äºˆç´„)\n"
    "- /event/2024/matsuri.html (ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±)\n"
    "- /kosodate/shien/index.html (å­è‚²ã¦æ”¯æ´)\n"
    "- /enquete.php?id=xxx (ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ)\n"
    "- /category/14-20-0-0-0-0-0-0-0-0.html (ã‚«ãƒ†ã‚´ãƒª)\n\n"
    
    "ã“ã®URLã‚’è¦‹ã¦ã€å»ºç¯‰è¦åˆ¶ã®å…·ä½“çš„æ•°å€¤ã‚’å«ã‚€å¯èƒ½æ€§ãŒéå¸¸ã«é«˜ã„å ´åˆã®ã¿ã€ã¯ã„ã€ã€"
    "å°‘ã—ã§ã‚‚ç–‘å•ãŒã‚ã‚‹å ´åˆã‚„ä»–ã®è¡Œæ”¿ã‚µãƒ¼ãƒ“ã‚¹ã®å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆã¯ã€ã„ã„ãˆã€ã¨ç­”ãˆã¦ãã ã•ã„ã€‚"
)

def _same_reg_domain(url, base):
    return tldextract.extract(url).registered_domain == tldextract.extract(base).registered_domain

def is_link_relevant(url: str, city: str, base_domain: str, key: str) -> bool:
    if not _same_reg_domain(url, base_domain):
        return False
    
    try:
        cli = OpenAI(api_key=key, http_client=httpx.Client(verify=False))
        rsp = cli.chat.completions.create(
            model="o3",
            messages=[
                {"role": "system", "content": _SYS},
                {"role": "user", "content": f"éƒ½å¸‚: {city}\nURL: {url}\n\nä¿å®ˆçš„ã«åˆ¤å®šã—ã¦ãã ã•ã„ï¼šã“ã®URLã¯å»ºç¯‰è¦åˆ¶ã®å…·ä½“çš„æ•°å€¤ã‚’å«ã‚€å¯èƒ½æ€§ãŒéå¸¸ã«é«˜ã„ã§ã™ã‹ï¼Ÿ"}
            ],
            temperature=0.0  # å®Œå…¨ç¡®å®šæ€§ï¼Œé¿å…éšæœºæ€§
        )
        result = "ã¯ã„" in rsp.choices[0].message.content.strip()
        
        # ğŸ”§ è°ƒè¯•è¾“å‡º - åªè®°å½•åˆ¤å®šä¸ºç›¸å…³çš„é“¾æ¥
        if result:
            print(f"ğŸ¤– [AIä¿å®ˆåˆ¤å®š] é–¢é€£ã¨åˆ¤å®š: {url}")
            print(f"   AIå›ç­”: {rsp.choices[0].message.content.strip()}")
        
        return result
        
    except Exception as e:
        print(f"GPT filter error for {url}: {e}")
        return False
